{% extends "clinica/base.html" %}

{% block title %}Minha Conta{% endblock %}

{% block content %}

<h3 class="mb-4">üë§ Minha Conta</h3>

<div class="row">

    <!-- DADOS DA CL√çNICA -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                üè• Dados da Cl√≠nica
            </div>
            <div class="card-body">
                <p><strong>Nome:</strong> {{ clinica.nome }}</p>
                <p><strong>Usu√°rio:</strong> {{ user.username }}</p>
                <p><strong>E-mail:</strong> {{ user.email|default:"N√£o informado" }}</p>
            </div>
        </div>
    </div>

    <!-- PLANO -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between">
                <span>üí≥ Plano Contratado</span>
                <button class="btn btn-sm btn-outline-secondary" disabled>
                    Alterar plano
                </button>
            </div>
            <div class="card-body">

                {% if clinica.plano %}
                    <p><strong>Plano:</strong> {{ clinica.plano.nome }}</p>
                    <p><strong>Pre√ßo:</strong> R$ {{ clinica.plano.preco }}</p>

                    {% if whatsapp_limite %}
                        <p class="mb-1">
                            <strong>WhatsApp:</strong>
                            {{ whatsapp_usados }} / {{ whatsapp_limite }} mensagens
                        </p>

                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar
                                {% if whatsapp_percentual >= 100 %}
                                    bg-danger
                                {% elif whatsapp_percentual >= 80 %}
                                    bg-warning
                                {% else %}
                                    bg-success
                                {% endif %}"
                                role="progressbar"
                                style="width: {{ whatsapp_percentual }}%;"
                                aria-valuenow="{{ whatsapp_percentual }}"
                                aria-valuemin="0"
                                aria-valuemax="100">
                                {{ whatsapp_percentual }}%
                            </div>
                        </div>

                        {% if whatsapp_percentual >= 100 %}
                            <small class="text-danger">
                                ‚ö†Ô∏è Limite de WhatsApp atingido
                            </small>
                        {% elif whatsapp_percentual >= 80 %}
                            <small class="text-warning">
                                ‚ö†Ô∏è Voc√™ est√° pr√≥ximo do limite
                            </small>
                        {% else %}
                            <small class="text-muted">
                                Uso normal
                            </small>
                        {% endif %}

                        <!-- üöÄ MENSAGEM DE UPGRADE -->
                        {% if whatsapp_percentual >= 80 %}
                            <div class="alert
                                {% if whatsapp_percentual >= 100 %}
                                    alert-danger
                                {% else %}
                                    alert-warning
                                {% endif %}
                                mt-3">

                                {% if whatsapp_percentual >= 100 %}
                                    <strong>üö´ Limite de WhatsApp atingido.</strong><br>
                                    Seu plano n√£o permite mais envios este m√™s.
                                {% else %}
                                    <strong>‚ö†Ô∏è Aten√ß√£o!</strong><br>
                                    Voc√™ est√° usando {{ whatsapp_percentual }}% do limite de WhatsApp.
                                {% endif %}

                                <hr>

                                <p class="mb-2">
                                    Considere fazer upgrade do plano para continuar usando o WhatsApp sem interrup√ß√µes.
                                </p>

                                <button class="btn btn-outline-dark btn-sm" disabled>
                                    Fazer upgrade do plano
                                </button>
                            </div>
                        {% endif %}

                    {% else %}
                        <div class="alert alert-success">
                            üì≤ WhatsApp ilimitado
                        </div>
                    {% endif %}

                {% else %}
                    <p class="text-muted">Nenhum plano associado.</p>
                {% endif %}

            </div>
        </div>
    </div>

</div>

<!-- CONTA DO USU√ÅRIO + HIST√ìRICO WHATSAPP -->
<div class="row mt-4">

    <!-- CONTA DO USU√ÅRIO -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                üîê Conta do Usu√°rio
            </div>
            <div class="card-body">
                <p><strong>Login:</strong> {{ user.username }}</p>
                <p><strong>E-mail:</strong> {{ user.email|default:"N√£o informado" }}</p>

                <a href="{% url 'password_change' %}"
                   class="btn btn-outline-primary btn-sm">
                    Alterar senha
                </a>
            </div>
        </div>
    </div>

    <!-- HIST√ìRICO MENSAL DE WHATSAPP -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                üìà Hist√≥rico de WhatsApp
            </div>
            <div class="card-body p-0">

                {% if historico_whatsapp %}
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>M√™s</th>
                                <th class="text-end">Mensagens</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in historico_whatsapp %}
                                <tr>
                                    <td>{{ item.mes|date:"m/Y" }}</td>
                                    <td class="text-end">{{ item.total }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted p-3">
                        Nenhum envio registrado ainda.
                    </p>
                {% endif %}

            </div>
        </div>
    </div>

</div>

{% endblock %}
